# 从零开始的微信硬件接入

## 一、目录

* 公众号申请与认证
* 开通设备功能
* 添加设备
* 开发接入流程
* 小程序的申请（非必须）
* 设备认证
* 测试并上线运营

## 二、公众号申请与认证

　　建议申请的公众号类型为*服务号*，以企业名义申请并进行认证！

关于微信硬件平台的接入流程如下：
　　
　　![接入步骤](/home/lsy/Documents/jierujiagou_final.png  "接入步骤")
　　
### 申请流程如下：

第一步：  访问网址：[微信公众平台](https://mp.weixin.qq.com/) ，进入后如下图所示：


![微信公众平台首页](/home/lsy/Documents/home.jpeg  "微信公众平台首页")


第二步：点击上图红框标识的*[立即注册](https://mp.weixin.qq.com/cgi-bin/registermidpage?action=index&lang=zh_CN)*按钮，进入选择公众号类型的页面，如下图所示：

![选择公众号类型](/home/lsy/Documents/choose_type.jpeg  "选择公众号类型")

第三步： 选择上图中的服务号，进入下一步，如下图所示：

![填写信息](/home/lsy/Documents/info_input.jpeg  "填写信息")

输入邮箱，注意此邮箱输入后，即为微信公众号登录的用户名，请确保邮箱真实有效，并不要丢失。密码填写后请牢记。

输入邮箱点击确认后，微信会发送一份邮件至您所填写的邮箱内，请打开邮箱，页面会跳转至邮箱激活页面，如下图：

![邮箱激活](/home/lsy/Documents/register.jpeg  "邮箱激活")


第四步：打开邮箱之后，点击邮件红色框位置的链接，以激活注册。如下图所示：

![邮箱激活内容](/home/lsy/Documents/mail_message.jpeg  "邮箱激活内容")

再次强调，请务必记住您的邮箱！当激活之后，将会跳转选择类型的页面。

第五步： 选择类型页面如下图：

![选择公众号类型](/home/lsy/Documents/choose_type_2.jpeg  "选择公众号类型")

您可以选择左边的*订阅号*类型，也可以选择红框标记的*服务号*类型（这里选择服务号），点击红框下*“选择并继续”*，会弹出提示信息，如下图：

![提示信息展示](/home/lsy/Documents/tips.jpeg  "提示信息展示")

点击确定即可！注意，确定之后公众号类型不能再更改！

第六步：在完成选择类型的操作后，会进入信息登记页面，如下图：

![信息登记](/home/lsy/Documents/register_info.jpeg  "信息登记")

选择红框中主体类型：企业。选择完毕，跳转进入填写信息的页面。

第七步：填写企业和运营者信息页面如下：

![填写企业和运营者信息](/home/lsy/Documents/input_info_2.jpeg  "填写企业和运营者信息")

按微信提示信息填写“主体信息登记”进行公众号注册。

注意：运营者姓名，即为微信公众号管理员。

以上信息填写完成后，会出现“运营者身份验证”，二维码需用个人微信扫描，扫码前注意个人微信需绑定与本人相关的一张银行卡（此为微信判断，上述运营者姓名身份证号信息，填写是否真实的凭据）请放心绑定银行卡后并扫码，扫码图片如下：

![扫码确认照片](/home/lsy/Documents/qrcode.jpeg  "扫码确认照片")

扫码之后，点击*继续*按钮，会弹出确认填写信息页面，点击确定即可，如下图：

![确认信息](/home/lsy/Documents/.jpeg  "确认信息")

第八步： 最后在确认公众号信息之后，需要填写公众号名称等内容，如下图：

![公众号可见内容](/home/lsy/Documents/gongzhonghao_info.jpeg  "公众号可见内容")

正式进入“公众号信息”填写阶段，请填写公众号名称。

*建议*：名称为用户搜索公众号的条件之一，相当于关键词搜索功能，我们建议使用中文，或大众熟知的英文，尽量减少使用简写，更有利于用户搜索到您的公众号。

*注意*：此过程仅为注册，如名称填写后还想修改，可以在认证过程中再次修改，但每次修改需向微信公众号缴纳300元。

第九步：在上面八个步骤都操作完成后，微信公众号就注册完成了，这时需要进一步微信认证才能使用微信公众号的各项内容。

未对公众号进行认证，请在30天内进行认证。认证工作与注册公众号，不是一个连贯流程的操作，可以由企业准备好相关资料后，另找时间操作。

认证位置：登录微信平台，左侧设置-微信认证，点击进行认证。由于认证工作，需企业上传营业执照等相关信息，建议您自己操作认证部分。

![](/home/lsy/Documents/renzheng.jpeg) 

![](/home/lsy/Documents/renzheng2.jpeg) 

### 认证流程（企业类型）如下：

第一步：登录微信公众平台=》设置=》微信认证=》开通

![开通认证](/home/lsy/Documents/start.jpg  "开通认证")

第二步：身份验证

![身份认证](/home/lsy/Documents/start2.jpg  "身份认证")

第三步： 勾选同意《微信公众平台认证服务协议》

![同意协议](/home/lsy/Documents/start3.jpg  "同意协议")

第四步：选择认证类型及填写认证资料

选择认证类型

![选择认证类型](/home/lsy/Documents/start4.jpg) 

企业业务资料填写

![](/home/lsy/Documents/start5.jpg) 

![](/home/lsy/Documents/start5_1.png) 


运营者信息填写

![运营者信息填写](/home/lsy/Documents/start8_1.jpg  "运营者信息填写")


企业基本资料上传

![企业基本资料上传](/home/lsy/Documents/start7.jpg  "企业基本资料上传")

第五步：确认名称

公众号名称可以选择3种命名方式：基于商标命名、基于媒体名命名、基于自选词汇；

![](/home/lsy/Documents/start_9_1.jpg) 


第六步：选择发票

![](/home/lsy/Documents/start9.jpg) 

第七步：支付费用

![](/home/lsy/Documents/start10.jpg) 

第八步：认证审核

我司收到打款后，会及时将该帐号认证申请派发给第三方审核公司进行审核。

![](/home/lsy/Documents/start11.jpg) 

温馨提示：

1、银行转账不是即时到账，所以还请耐心等待5个工作日左右
2、我司收到打款后会在小信封通知对应审核公司名称及联系方式

认证完成后，公众号就正式可用了！

## 三、开通设备功能并添加设备

下面的操作针对设备商云连接微信硬件云通道的配置接入，流程如下：

![设备商云接入](/home/lsy/Documents/shebeishangyunjieru.png  "设备商云接入")

接入步骤如下：

第一步：登录微信公众平台，点击左边功能栏的"添加功能插件"，选择"设备功能"。

![添加功能](/home/lsy/Documents/shebeijieru_1.png  "添加功能")

点击"开通"，阅读并同意《微信公众平台微信互联设备功能服务协议》。

![](/home/lsy/Documents/shebeijieru_2.png) 

![](/home/lsy/Documents/shebeijieru_3.png) 

第二步：添加产品

进行产品开发前，第三方需要在"公众平台-设备功能"内添加接入的产品。一个公众号允许添加多种产品（比如可以添加N款音箱和N款车机），每种添加成功的产品都默认获得微信硬件平台分配的100个设备授权配额。

2.1进入"设备功能"，点击"添加产品"

![添加产品](/home/lsy/Documents/shebeijieru_4.png) 

2.2产品基础资料登记

![产品基础资料登记](/home/lsy/Documents/shebeijieru_5_1.png) 

其中，接入方案中勾选“微信硬件云标准接入方案”——厂商云连接微信硬件云通道。“厂商云连接微信硬件云通道”即：

![厂商云连接微信硬件云操作](/home/lsy/Documents/shebeijieru_6.png) 

2.3产品能力登记

![产品能力登记](/home/lsy/Documents/shebeijieru_7.png) 

这样添加产品就完成了！

## 四、开发接入流程

### 1. 接入方案介绍

设备接入方案即设备接入微信硬件平台使用的数据传输方案，目前包含平台基础接入方案与微信硬件云标准接入方案。

1.平台基础接入方案
适用对象：
（1）拥有后台服务器的设备厂商
（2）希望在公众号体系内独立实现设备相关功能（即不需要微信硬件平台提供的产品标准能力）
（3）希望设备可以收发微信消息（图片／音乐／文件／地理位置等）

微信硬件平台是基于微信公众平台基础构建的，微信公众平台基础技术架构如下图所示。

![微信平台技术架构](/home/lsy/Documents/jishujiagou_1.jpg  "微信平台技术架构")


公众号运营分为编辑模式和开发模式。

在编辑模式下，公众号运营者登录微信公众号管理页面，通过手动方式编辑消息和管理用户。
在开发模式下，运营者可以获得更多高级的接口功能（包括设备功能），通过编写消息接口程序，让第三方服务器自动管理用户和消息。

![微信硬件平台基础接入方案技术架构](/home/lsy/Documents/jishujiagou_2.jpg) 

在这个基础架构里，设备厂家必须有自己的服务器，通过硬件平台基础消息接口，接收设备和用户消息，提供设备服务。

2.微信硬件云标准接入方案
适用对象：希望通过微信硬件平台提供的产品标准能力集定义设备数据，实现设备数据互联互通的设备。

（1）设备直连微信硬件云通道
微信硬件平台为设备提供直连数据通道，设备可以通过直连SDK直接接入微信硬件服务器，打通设备到云端的通道。框架下图所示：

![直连数据通道](/home/lsy/Documents/jier.png  "直连数据通道")

在直连方案中，微信硬件平台将提供设备信息管理、绑定关系存储、设备权限管理、设备固件版本控制、设备数据统计、数据登录鉴权、状态更新、固件更新等服务。

具体描述：请参照文档[新增直连数据通道](http://iot.weixin.qq.com/wiki/new/index.html?page=3-3) 

（2）设备商云连接微信硬件云通道
设备连接厂商服务器后，可通过设备openAPI与微信硬件云对接。框架如下图所示：

![设备商云接入通道](/home/lsy/Documents/jierujiagou_2.png  "设备商云接入通道")

目前，设备厂商可通过微信硬件平台提供的开发模式接入设备。整体技术架构如图5所示：

![整体技术架构](/home/lsy/Documents/jishujiagou_3.jpg  "整体技术架构")

### 2.正式开发

#### （1）内容简介

　　利用公众号作为入口，微信配网原生Airkiss界面可通过JS-SDK由“微信内网页（即在手机微信APP内打开的网页）”调起。本篇我们来了解一下“微信内网页”接口开发，用JavaWeb后台代码实现微信JS-SDK注入配置，以及用前端JS调用相关接口。
　　这里主要使用Spring框架进行开发，配合有人物联网的wifi模块——USR-C201来进行Airkiss的配网，我们这里也会编写一个简单的页面作为前置，通过页面内的JavaScript函数调用微信的jsAPI来实现配网。
　
　
####（2）开发步骤
　　开发步骤分为两部分，第一部分是编写代码之前的准备，包括：
* １．ngrok内网穿透服务的搭建（有独立服务器和域名的用户可以跳过）
* ２．微信接口测试号申请
* ３．使用微信Web开发者工具调试网页
* ４．保证自己能随时查看微信开发者文档
　　
第二部分就是编写代码的部分，包括：
* １．选择微信后端开发框架
* ２．简单添加微信菜单
* ３．编写一个后端接口
* ４．编写一个简单的前端页面
* ５．JSSDK和JSAPI配置参数信息
* ６．开始调用wifi配网
* ７．接口测试
* ８．正式完成

#### （３）ngrok内网穿透服务的搭建
		
		ngrok 是一款用go 语言开发的开源软件，它是一个反向代理，通过在公共的端点和 本地运行的Web 服务器之间建立一个安全的通道。
		
使用JS-SDK需要在微信公众号绑定JS接口安全域名，且**不支持IP地址及端口号**，所以我们需要一个域名来访问页面。难道又要花重金买服务器和域名？不不不，这样就太麻烦了。对，不是钱的问题，是麻烦。难道你每次改完代码都要重新部署一遍再来看结果？我们现在可是在开发调试啊……

如果能把在**本地启动调试的网页映射到外网的域名**上就好了，所以就有了[ngrok](https://ngrok.com/) 这个神器，不但能在外网访问，而且还有域名！在开发时偶得QQ浏览器团队服务器版的ngrok，炒鸡好用，推荐大家使用。按照教程[[工具] 使用 Ngrok 来帮助你实现本机外网访问](https://laravel-china.org/topics/2639/tools-use-ngrok-to-help-you-achieve-the-machine-network-access) 先把ngrok下载、配置好。

下载ngrok.exe文件，并在同目录下创建 **ngrok.conf** 配置文件，并根据需要更改配置文件。

		trust_host_root_certs: false
		server_addr: proxy.qqbrowser.cc:4443
		inspect_addr: 0.0.0.0:4040
		tunnels:
  		   wechat:
    		   subdomain: shaoguoji
    		   proto:
      			http: 127.0.0.1:44073


我的 *ngrok.conf* 文件中配置了一个名为“wechat”的映射，域名开头为“shaoguoji”，~~完整的域名为“shaoguoyi.ngrok.abc.cn”（仅供参考，请以自己的域名为准！）~~，指向本地（127.0.0.1为本机地址）的44073端口。

保存配置文件，在cmd命令行窗口进入ngrok所在目录（我的在C:\ngrok），敲入 ngrok start wechat 命令运行ngrok开始域名映射，得到的域名 shaoguoji.proxy.qqbrowser.cc 就可以用来开发啦。

![ngrok连接](/home/lsy/Documents/ngrok.png  "ngrok连接")

在浏览器输入地址 http://localhost:4040/http/in# 可以进入ngrok后台管理页面，查看请求报文。如下图所示：

![ngrok管理页面](/home/lsy/Documents/ngrok_manager.png  "ngrok管理页面")

这还没完呢，等下还要再修改配置，将ngrok指向网站启动的具体端口才能进行外网访问。

		注：１．不知道什么原因，这个版本的ngrok长时间运行会自动退出，每次都要手动再运行，郁闷……
		　　２．如果想要自行搭建ngrok服务，请参考这篇文章：
		　　从零教你搭建ngrok服务，解决外网调试本地站点: https://morongs.github.io/2016/12/28/dajian-ngrok/
		
#### （４）微信接口测试号申请

　　不需要注册审核，微信给开发者提供了接口测试号，手机扫一扫即可登录，就在[微信公众平台开发者文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1445241432) 左侧目录“开始开发”下的[接口测试号申请](http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login) 中。登录后可以扫描“测试号二维码”关注此公众号。也可以直接访问[微信公众平台接口测试帐号申请 - 腾讯](mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login) ，扫码即可登录。登录前如下图：
　　
　　![微信公众号测试登录](/home/lsy/Documents/weixin_test_1.png  "微信公众号测试登录")
　　
登录后如下图所示：

![微信测试２](/home/lsy/Documents/weixin_test_2.png  "微信测试成功登录")

#### （５）使用微信Web开发者工具调试网页

　　调用JS-SDK的页面要在微信内打开才有效，由于每次用手机调试的话略显繁琐与不便，调试信息也不全面。于是微信官方提供了“Web开发者工具”，相当 于PC端的一个微信客户端模拟器了（浏览器），同样也可以扫码登录。

请访问[微信开发者文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1455784140) 来下载，具体界面如下图：

![](/home/lsy/Documents/weixin_tools.png) 

#### （６）随时查看微信开发者文档

　　我个人是很不善于看文档开发的，对文档也非常恐惧。但请不要学我！很多时候在网上找了一大堆文章或视频教程来看，最后才发现文档写着清清楚楚呢……所以，遇到任何问题务必先查阅文档。
　　
* [微信公众平台开发者文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1445241432) 
* 微信JSSDK说明文档（同上）
* [AirKiss2.0开发文档](http://iot.weixin.qq.com/wiki/new/index.html?page=4-1-2) 

#### （７）开发框架选择

　　为了快速开发起见，我们需要选择一个快速开发框架，或者叫做快速开发工具包。这里我们使用这个框架：[微信支付/公众号/企业号/小程序的Java开发工具包（SDK）](https://github.com/Wechat-Group/weixin-java-tools) 。
　　然后我们使用Intellij IDEA这个工具来进行开发，构建工具选择maven，然后我们下载这个[demo](https://github.com/binarywang/weixin-java-mp-demo) 作为开始，根据这个项目进行开发。
　　最后，我们会涉及到页面的开发，我们的模板引擎选择[thymeleaf](http://www.thymeleaf.org/) 来进行开发，后续我们会进行相关配置。
　　
#### （８）

